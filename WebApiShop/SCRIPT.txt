-- 1. יצירת מסד הנתונים
CREATE DATABASE RealEstateDB_;
GO

-- 2. מעבר לשימוש במסד הנתונים שיצרנו
USE RealEstateDB_;
GO

-- 3. יצירת טבלת משתמשים (Users)
CREATE TABLE Users (
    UserID INT PRIMARY KEY IDENTITY(1,1),
    FullName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(100) UNIQUE NOT NULL,
    Password NVARCHAR(255) NOT NULL,
    Phone NVARCHAR(20),
    Address NVARCHAR(MAX),
    IsAdmin BIT DEFAULT 0
);

-- 4. יצירת טבלת קטגוריות (Categories)
CREATE TABLE Categories (
    CategoryID INT PRIMARY KEY IDENTITY(1,1),
    CategoryName NVARCHAR(50) NOT NULL,
    Description NVARCHAR(500)
);

-- 5. יצירת טבלת דירות/מוצרים (Products)
CREATE TABLE Products (
    ProductID INT PRIMARY KEY IDENTITY(1,1),
    Title NVARCHAR(200) NOT NULL,
    Description NVARCHAR(MAX),
    Price DECIMAL(18, 2) NOT NULL,
    ImageUrl NVARCHAR(MAX),
    CategoryID INT,
    City NVARCHAR(100),
    Rooms INT,
    Beds INT DEFAULT 0,
    OwnerID INT, 
    IsAvailable BIT DEFAULT 1,
    CreatedDate DATETIME DEFAULT GETDATE(),
    
    CONSTRAINT FK_Product_Category 
        FOREIGN KEY (CategoryID) REFERENCES Categories(CategoryID),

    CONSTRAINT FK_Product_Owner 
        FOREIGN KEY (OwnerID) REFERENCES Users(UserID)
);

-- 6. יצירת טבלת הזמנות (Orders)
CREATE TABLE Orders (
    OrderID INT PRIMARY KEY IDENTITY(1,1),
    UserID INT NOT NULL,
    OrderDate DATETIME DEFAULT GETDATE(),
    TotalAmount DECIMAL(18, 2) NOT NULL,
    Status NVARCHAR(50) DEFAULT 'Pending',
    
    CONSTRAINT FK_Order_User 
        FOREIGN KEY (UserID) REFERENCES Users(UserID)
);

-- 7. יצירת טבלת פרטי הזמנה (OrderItems)
CREATE TABLE OrderItems (
    OrderItemID INT PRIMARY KEY IDENTITY(1,1),
    OrderID INT NOT NULL,
    ProductID INT NOT NULL,
    
    StartDate DATETIME NULL,
    EndDate DATETIME NULL,
    
    PriceAtPurchase DECIMAL(18, 2) NOT NULL,
    
    CONSTRAINT FK_Item_Order 
        FOREIGN KEY (OrderID) REFERENCES Orders(OrderID) ON DELETE CASCADE,

    CONSTRAINT FK_Item_Product 
        FOREIGN KEY (ProductID) REFERENCES Products(ProductID)
);

-- 8. יצירת טבלת תמונות נוספות למוצר
CREATE TABLE ProductImages (
    ImageID INT PRIMARY KEY IDENTITY(1,1),
    ProductID INT NOT NULL,
    AdditionalImageUrl NVARCHAR(MAX) NOT NULL,
    
    CONSTRAINT FK_ProductImages_Products 
        FOREIGN KEY (ProductID) 
        REFERENCES Products(ProductID) ON DELETE CASCADE
);

-- 9. יצירת טבלת לוגים/דירוגים (Ratings)
CREATE TABLE Ratings (
    RatingId INT PRIMARY KEY IDENTITY(1,1),
    Host NVARCHAR(255),
    Method NVARCHAR(50),
    Path NVARCHAR(500),
    RecordDate DATETIME DEFAULT GETDATE(),
    Referer NVARCHAR(500),
    UserAgent NVARCHAR(1000)
);
GO
